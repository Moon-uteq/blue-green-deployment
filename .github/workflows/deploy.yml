name: Blue-Green Deployment to DigitalOcean

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (blue or green)'
        required: true
        default: 'green'
        type: choice
        options:
          - blue
          - green
      auto_switch:
        description: 'Automatically switch traffic after successful deployment'
        required: false
        default: false
        type: boolean

env:
  PROJECT_NAME: blue-green-app
  NODE_VERSION: '18'

jobs:
  # Build and Test Job
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Run tests
      run: npm test -- --coverage --watchAll=false

    - name: Build application
      run: npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: build/
        retention-days: 1

  # Deploy Job to DigitalOcean
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: build/

    - name: Set deployment variables
      run: |
        # Determine target environment
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "TARGET_ENV=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          echo "AUTO_SWITCH=${{ github.event.inputs.auto_switch }}" >> $GITHUB_ENV
        else
          # Auto-determine environment based on current active environment
          echo "TARGET_ENV=auto" >> $GITHUB_ENV
          echo "AUTO_SWITCH=false" >> $GITHUB_ENV
        fi
        
        # Set version tag
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "VERSION=v$(date +%Y%m%d-%H%M%S)-$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_ENV
        else
          echo "VERSION=dev-$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_ENV
        fi

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.DO_SSH_PRIVATE_KEY }}

    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.DO_SERVER_IP }} >> ~/.ssh/known_hosts

    - name: Determine inactive environment
      if: env.TARGET_ENV == 'auto'
      run: |
        # Check which environment is currently active
        ACTIVE_ENV=$(ssh root@${{ secrets.DO_SERVER_IP }} "curl -s -I http://localhost:8080/status | grep X-Active-Environment | cut -d' ' -f2 | tr -d '\r'")
        
        echo "Current active environment: $ACTIVE_ENV"
        
        if [ "$ACTIVE_ENV" = "blue" ]; then
          echo "TARGET_ENV=green" >> $GITHUB_ENV
          echo "âœ… Active environment is blue, deploying to green"
        else
          echo "TARGET_ENV=blue" >> $GITHUB_ENV
          echo "âœ… Active environment is green, deploying to blue"  
        fi

    - name: Deploy to DigitalOcean
      env:
        VERSION: ${{ env.VERSION }}
        TARGET_ENV: ${{ env.TARGET_ENV }}
      run: |
        echo "ðŸš€ Starting deployment to DigitalOcean..."
        echo "Version: $VERSION"
        echo "Environment: $TARGET_ENV"
        
        # Create deployment directory on server
        ssh root@${{ secrets.DO_SERVER_IP }} "mkdir -p /opt/blue-green-app"
        
        # Copy project files to server
        scp -r ./* root@${{ secrets.DO_SERVER_IP }}:/opt/blue-green-app/blue-green-deployment/
        
        # Execute deployment on server
        ssh root@${{ secrets.DO_SERVER_IP }} << EOF
          cd /opt/blue-green-app/blue-green-deployment
          
          # Make scripts executable
          chmod +x scripts/*.sh
          
          # Stop existing containers properly
          docker-compose down --remove-orphans || true
          docker network prune -f || true
          
          # Build and deploy to target environment
          echo "Deploying version $VERSION to $TARGET_ENV environment"
          ./scripts/deploy.sh $VERSION $TARGET_ENV
          
        EOF

    - name: Run health checks
      env:
        TARGET_ENV: ${{ env.TARGET_ENV }}
      run: |
        echo "ðŸ” Running health checks..."
        echo "Target environment: $TARGET_ENV"
        ssh root@${{ secrets.DO_SERVER_IP }} << EOF
          cd /opt/blue-green-app/blue-green-deployment
          ./scripts/health-check.sh $TARGET_ENV
        EOF

    - name: Switch traffic (if auto-switch enabled)
      if: env.AUTO_SWITCH == 'true'
      run: |
        echo "ðŸ”„ Auto-switching traffic to $TARGET_ENV environment"
        ssh root@${{ secrets.DO_SERVER_IP }} << EOF
          cd /opt/blue-green-app/blue-green-deployment
          ./scripts/switch.sh $TARGET_ENV
        EOF

    - name: Deployment summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Server**: ${{ secrets.DO_SERVER_IP }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: $TARGET_ENV" >> $GITHUB_STEP_SUMMARY
        echo "- **Auto Switch**: $AUTO_SWITCH" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Access URLs:**" >> $GITHUB_STEP_SUMMARY
        echo "- Load Balancer: http://${{ secrets.DO_SERVER_IP }}:8080" >> $GITHUB_STEP_SUMMARY
        echo "- Blue Environment: http://${{ secrets.DO_SERVER_IP }}:3001" >> $GITHUB_STEP_SUMMARY
        echo "- Green Environment: http://${{ secrets.DO_SERVER_IP }}:3002" >> $GITHUB_STEP_SUMMARY
        if [ "$AUTO_SWITCH" == "false" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps**: SSH to server and run \`./scripts/switch.sh $TARGET_ENV\` to switch traffic" >> $GITHUB_STEP_SUMMARY
        fi

  # Manual Rollback Job
  rollback:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'rollback'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.DO_SSH_PRIVATE_KEY }}

    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.DO_SERVER_IP }} >> ~/.ssh/known_hosts

    - name: Perform rollback
      run: |
        echo "ðŸ”„ Performing rollback..."
        ssh root@${{ secrets.DO_SERVER_IP }} << 'EOF'
          cd /opt/blue-green-app/blue-green-deployment
          
          # Determine current active environment and switch to the other
          CURRENT_ENV=$(curl -s -I localhost:8080/status | grep X-Active-Environment | cut -d' ' -f2 | tr -d '\r')
          
          if [ "$CURRENT_ENV" = "blue" ]; then
            ROLLBACK_ENV="green"
          else
            ROLLBACK_ENV="blue"
          fi
          
          echo "Rolling back from $CURRENT_ENV to $ROLLBACK_ENV"
          ./scripts/switch.sh $ROLLBACK_ENV
          
        EOF

    - name: Verify rollback
      run: |
        ssh root@${{ secrets.DO_SERVER_IP }} << 'EOF'
          cd /opt/blue-green-app/blue-green-deployment
          # Wait a moment for switch to take effect
          sleep 5
          # Verify the new environment is responding
          curl -f http://localhost:8080/status
          echo "Rollback completed successfully!"
        EOF