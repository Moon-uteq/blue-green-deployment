name: Full Auto Blue-Green Deployment

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.DO_SSH_PRIVATE_KEY }}

    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.DO_SERVER_IP }} >> ~/.ssh/known_hosts

    - name: Auto Blue-Green Deployment
      run: |
        ssh root@${{ secrets.DO_SERVER_IP }} << 'EOF'
          cd /opt/blue-green-app/blue-green-deployment
          
          # Update code
          git pull origin main
          chmod +x scripts/*.sh
          
          # Detect current active environment
          ACTIVE_ENV=$(curl -s -I http://localhost:8080/status | grep X-Active-Environment | cut -d' ' -f2 | tr -d '\r')
          
          # Determine inactive environment for deployment
          if [ "$ACTIVE_ENV" = "blue" ]; then
            TARGET_ENV="green"
            echo "ðŸŸ¦ Blue is ACTIVE â†’ Deploying to GREEN"
          else
            TARGET_ENV="blue"
            echo "ðŸŸ¢ Green is ACTIVE â†’ Deploying to BLUE"
          fi
          
          # Deploy to inactive environment
          echo "ðŸ“¦ Deploying to $TARGET_ENV..."
          ./scripts/deploy.sh v1.0 $TARGET_ENV
          
          # Auto-switch traffic to new deployment
          echo "ðŸ”„ Auto-switching traffic to $TARGET_ENV..."
          ./scripts/switch.sh $TARGET_ENV
          
          echo "âœ… Complete! $TARGET_ENV is now ACTIVE"
          
        EOF